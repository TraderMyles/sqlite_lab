{% extends "base.html" %}
{% block content %}
<h1>Contacts</h1>

<form action="{{ url_for('contacts_list') }}" method="get" class="row">
  <input type="text" name="q" value="{{ q }}" placeholder="Search contacts">
  <button type="submit">Search</button>
</form>

<h2>Add / Update Contact</h2>
<form action="{{ url_for('contacts_add') }}" method="post" class="grid form">
  <input type="text" name="name" placeholder="Full name" required>
  <input type="email" name="email" placeholder="Email (used to upsert)">
  <input type="text" name="phone" placeholder="Phone">
  <input type="text" name="company" placeholder="Company">
  <button type="submit">Save</button>
</form>

<h2>Contacts</h2>
<table>
  <thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Company</th><th>Notes</th><th>Actions</th></tr></thead>
  <tbody>
  {% for r in rows %}
    <tr>
      <td>{{ r.full_name }}</td>
      <td>{{ r.email }}</td>
      <td>{{ r.phone }}</td>
      <td>{{ r.company }}</td>
      <td>{{ r.note_count }}</td>
      <td class="actions">
        <form action="{{ url_for('contacts_delete', contact_id=r.contact_id) }}" method="post" onsubmit="return confirm('Delete contact and notes?');">
          <button type="submit" class="danger">Delete</button>
        </form>
        <details>
          <summary>Add note</summary>
          <form action="{{ url_for('contacts_add_note', contact_id=r.contact_id) }}" method="post" class="col form">
            <input type="date" name="date">
            <input type="text" name="title" placeholder="Title">
            <textarea name="body" rows="3" placeholder="Note text" required></textarea>
            <button type="submit">Save note</button>
          </form>
        </details>
      </td>
    </tr>
  {% endfor %}
  </tbody>
</table>

<h2>Recent Notes</h2>
<table>
  <thead><tr><th>Date</th><th>Contact</th><th>Title</th><th>Preview</th></tr></thead>
  <tbody>
  {% for n in notes %}
    <tr>
      <td>{{ n.note_date }}</td>
      <td>{{ n.full_name }}</td>
      <td>{{ n.title }}</td>
      <td>{{ n.preview }}</td>
    </tr>
  {% endfor %}
  </tbody>
</table>
{% endblock %}
